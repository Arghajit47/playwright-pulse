<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Usage - Playwright Pulse Report</title>
    <link rel="icon" href="./asset/logo.png" type="image/png" sizes="32x32" />
    <link rel="apple-touch-icon" href="./asset/logo.png">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <button
      class="menu-toggle"
      id="menu-toggle"
      aria-label="Open navigation menu"
    >
      â˜°
    </button>
    <div class="page-wrapper">
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <img
            src="./asset/FullLogo.png"
            alt="Playwright Pulse Report Banner"
            class="sidebar-banner"
          />
        </div>
        <ul class="sidebar-nav">
          <li><a href="index.html">Getting Started</a></li>
          <li><a href="reporters-scripts.html">Reporters & Scripts</a></li>
          <li><a href="report-features.html">Report Features</a></li>
          <li>
            <a href="advanced-usage.html" class="active">Advanced Usage</a>
          </li>
          <li><a href="comparison.html">Comparison</a></li>
          <li><a href="reference.html">Reference</a></li>
          <li>
            <a
              href="https://arghajit47.github.io/playwright-pulse-dashboard/"
              class="external-link"
              target="_blank"
              rel="noopener noreferrer"
            >
              Pulse Dashboard
              <img class="new" src="./asset/new.png" alt="new_icon" />
            </a>
          </li>
        </ul>
      </nav>
      <div class="overlay" id="overlay"></div>
      <main class="main-content">
        <h1>Advanced Usage</h1>
        <section id="advanced-config">
          <h2>Full Configuration</h2>
          <p>
            The reporter can be configured with the following options in your
            <code>playwright.config.ts</code>:
          </p>
          <table>
            <thead>
              <tr>
                <th>Option</th>
                <th>Type</th>
                <th>Default</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>outputDir</code></td>
                <td><code>string</code></td>
                <td><code>'pulse-report'</code></td>
                <td>The directory where all report assets will be saved.</td>
              </tr>
              <tr>
                <td><code>outputFile</code></td>
                <td><code>string</code></td>
                <td><code>'playwright-pulse-report.json'</code></td>
                <td>The name of the main JSON data file.</td>
              </tr>
              <tr>
                <td><code>resetOnEachRun</code></td>
                <td><code>boolean</code></td>
                <td><code>true</code></td>
                <td>
                  If <code>false</code>, the reporter will merge results from
                  sequential runs in the same job.
                </td>
              </tr>
            </tbody>
          </table>
        </section>

        <section id="advanced-ci">
          <h2>CI/CD Workflow for Sharding</h2>
          <div class="ci-buttons">
            <button onclick="showCode('github')" class="active">
              GitHub Actions
            </button>
            <button onclick="showCode('gitlab')">GitLab CI/CD</button>
            <button onclick="showCode('jenkins')">Jenkins</button>
          </div>
          <div id="github-code" class="code-container">
            <pre><code class="language-yaml"># .github/workflows/playwright.yml
name: Playwright Tests with Pulse Report
on: [push]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npx playwright test --shard=${{ matrix.shard }}/${{ strategy.job-total }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pulse-report-shard-${{ matrix.shard }}
          path: pulse-report/
          retention-days: 1

  merge-report:
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm ci
      - uses: actions/download-artifact@v4
        with:
          path: pulse-report
          pattern: pulse-report-shard-*
          merge-multiple: true
      - run: npx merge-pulse-report
      - run: npx generate-pulse-report
      - uses: actions/upload-artifact@v4
        with:
          name: final-playwright-pulse-report
          path: pulse-report/playwright-pulse-static-report.html
          retention-days: 7</code></pre>
          </div>
          <div id="gitlab-code" class="code-container" style="display: none">
            <pre><code class="language-yaml"># .gitlab-ci.yml
stages:
  - test
  - merge

playwright-test:
  stage: test
  parallel: 4
  image: node:18
  script:
    - npm ci
    - npx playwright install --with-deps
    - npx playwright test --shard=$CI_NODE_INDEX/$CI_NODE_TOTAL
  artifacts:
    when: always
    paths: [pulse-report/]
    expire_in: 1 day

merge-and-publish:
  stage: merge
  needs: ["playwright-test"]
  image: node:18
  script:
    - npm ci
    - npx merge-pulse-report
    - npx generate-pulse-report
  artifacts:
    paths: [pulse-report/playwright-pulse-static-report.html]
    expire_in: 7 days</code></pre>
          </div>
          <div id="jenkins-code" class="code-container" style="display: none">
            <pre><code class="language-groovy">// Jenkinsfile
pipeline {
    agent any
    stages {
        stage('Setup') {
            steps {
                sh 'npm ci'
                sh 'npx playwright install --with-deps'
            }
        }
        stage('Parallel Tests') {
            parallel {
                stage('Shard 1') { steps { sh 'npx playwright test --shard=1/4' } }
                stage('Shard 2') { steps { sh 'npx playwright test --shard=2/4' } }
                stage('Shard 3') { steps { sh 'npx playwright test --shard=3/4' } }
                stage('Shard 4') { steps { sh 'npx playwright test --shard=4/4' } }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'pulse-report/**', allowEmptyArchive: true
                }
            }
        }
        stage('Merge and Publish Report') {
            steps {
                // Logic to unstash artifacts from all shards would go here
                sh 'npx merge-pulse-report'
                sh 'npx generate-pulse-report'
                archiveArtifacts artifacts: 'pulse-report/playwright-pulse-static-report.html'
            }
        }
    }
}</code></pre>
          </div>
        </section>

        <section id="sequential-run">
          <h2>Handling Sequential Test Runs</h2>
          <span
            >By default, the reporter will overwrite the
            `playwright-pulse-report.json` file on each new test run. This is
            usually what we want. However, if we run tests sequentially in the
            same job, like this:</span
          >
          <div id="run-execution" class="code-container">
            <pre><code class="language-javascript">npx playwright test test1.spec.ts && npx playwright test test2.spec.ts</code></pre>
          </div>
          <span
            >By default, In this above scenario, the report from test1 will be
            lost. To solve this, you can use the resetOnEachRun option.</span
          >
          <div id="run-execution" class="code-container">
            <pre><code class="language-javascript"># playwright.config.ts


import { defineConfig } from "@playwright/test";
import * as path from "path";
              
// Define where the final report JSON and HTML should go
const PULSE_REPORT_DIR = path.resolve(__dirname, "pulse-report"); // Example: a directory in your project root
              
export default defineConfig({
  reporter: [
    ["list"],
    [
      "@arghajit/playwright-pulse-report",
      {
        outputDir: PULSE_REPORT_DIR,
        // Add this option
        resetOnEachRun: false, // Default is true
      },
    ],
  ],
  // ...
});</code></pre>
          </div>
          <strong>How it works when resetOnEachRun: false:</strong><br /><br />
          <span>
            - On the first run, it saves report-1.json to a
            pulse-report/pulse-results directory and creates the main
            playwright-pulse-report.json from it.</span
          ><br />
          <span>
            - On the second run, it saves report-2.json to the same
            directory.</span
          ><br />
          <span>
            - It then automatically reads both report-1.json and report-2.json,
            merges them, and updates the main playwright-pulse-report.json with
            the combined results.</span
          ><br /><br />
          <strong
            ><i
              >This ensures your final report is always a complete summary of
              all sequential test runs.</i
            ></strong
          >
        </section>
      </main>
    </div>
    <script src="script.js"></script>
    <script>
      function showCode(platform) {
        document
          .querySelectorAll(".code-container")
          .forEach((c) => (c.style.display = "none"));
        document
          .querySelectorAll(".ci-buttons button")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`${platform}-code`).style.display = "block";
        event.currentTarget.classList.add("active");
      }
    </script>
  </body>
</html>
